<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MiniLabo Dashboard</title>
  <style>
    body { background:#0d1117; color:#d0d0d0; font-family:Arial,Helvetica,sans-serif; margin:0; }
    header { padding:1rem; text-align:center; font-size:1.5rem; background:#161b22; border-bottom:1px solid #30363d; }
    #loginForm { width:300px; margin:5rem auto; padding:2rem; background:#161b22; border-radius:0.5rem; box-shadow:0 0 10px rgba(0,0,0,0.5); }
    #loginForm input { width:100%; padding:0.5rem; margin:0.5rem 0; color:#0d1117; }
    #loginForm .numpad { display:grid; grid-template-columns:repeat(3,1fr); gap:0.5rem; margin-top:1rem; }
    #loginForm .numpad button { background:#30363d; padding:0.75rem; font-size:1.2rem; }
    #loginForm .numpad button:hover { background:#484f58; }
    #loginForm .numpad-actions { display:flex; gap:0.5rem; margin-top:0.5rem; }
    #loginForm .numpad-actions button { flex:1; background:#484f58; }
    #dashboard { display:none; padding:1rem; }
    .cards { display:flex; flex-wrap:wrap; gap:1rem; }
    .card { background:#161b22; border:1px solid #30363d; border-radius:0.5rem; padding:1rem; flex:1; min-width:250px; }
    button { background:#238636; color:#fff; border:none; padding:0.5rem 1rem; border-radius:0.3rem; cursor:pointer; }
    button:hover { background:#2ea043; }
    input, select { background:#0d1117; border:1px solid #30363d; color:#d0d0d0; border-radius:0.3rem; padding:0.3rem; }
    #logsPanel { background:#0d1117; border:1px solid #30363d; max-height:200px; overflow:auto; padding:0.5rem; margin-top:1rem; }
  </style>
</head>
<body>
  <header>MiniLabo</header>
  <div id="loginForm">
    <h2>Connexion</h2>
    <label for="pinInput">Code PIN&nbsp;:</label><br>
    <input type="password" id="pinInput" maxlength="4" inputmode="numeric" pattern="[0-9]*"><br>
    <div class="numpad">
      <button type="button" onclick="appendDigit('1')">1</button>
      <button type="button" onclick="appendDigit('2')">2</button>
      <button type="button" onclick="appendDigit('3')">3</button>
      <button type="button" onclick="appendDigit('4')">4</button>
      <button type="button" onclick="appendDigit('5')">5</button>
      <button type="button" onclick="appendDigit('6')">6</button>
      <button type="button" onclick="appendDigit('7')">7</button>
      <button type="button" onclick="appendDigit('8')">8</button>
      <button type="button" onclick="appendDigit('9')">9</button>
      <div></div>
      <button type="button" onclick="appendDigit('0')">0</button>
      <div></div>
    </div>
    <div class="numpad-actions">
      <button type="button" onclick="clearPin()">Effacer</button>
      <button type="button" onclick="backspacePin()">⌫</button>
    </div>
    <button type="button" onclick="login()">Se connecter</button>
    <p id="loginStatus" style="color:red;"></p>
  </div>
  <div id="dashboard">
    <div class="cards">
      <div class="card" id="cardDMM">
        <h3>Multimètre</h3>
        <div id="dmmValues">...</div>
        <div>
          Canal: <select id="dmmSelect"></select>
        </div>
      </div>
      <div class="card" id="cardScope">
        <h3>Oscilloscope</h3>
        <canvas id="scopeCanvas" width="300" height="150" style="background:#0d1117;border:1px solid #30363d;"></canvas>
        <p>En développement...</p>
      </div>
      <div class="card" id="cardFunc">
        <h3>Générateur de fonction</h3>
        <div>
          Cible: <select id="funcTarget"></select><br>
          Fréquence (Hz): <input type="number" id="funcFreq" value="50"><br>
          Amplitude (%): <input type="number" id="funcAmp" value="50"><br>
          Offset (%): <input type="number" id="funcOff" value="0"><br>
          Forme: <select id="funcWave">
            <option value="sine">Sinus</option>
            <option value="square">Carré</option>
            <option value="triangle">Triangle</option>
          </select><br>
          <button onclick="updateFunc()">Appliquer</button>
        </div>
      </div>
      <div class="card" id="cardIO">
        <h3>IO disponibles</h3>
        <ul id="ioList" style="list-style:none; padding-left:0;"></ul>
      </div>
    </div>
    <div>
      <button onclick="toggleLogs()" id="logsBtn">Afficher les logs</button>
    </div>
    <div id="logsPanel" style="display:none;"></div>
  </div>
  <script>
    const pinInput = document.getElementById('pinInput');

    function sanitizePin(value) {
      return (value || '').replace(/[^0-9]/g, '').slice(0, 4);
    }

    function appendDigit(digit) {
      pinInput.value = sanitizePin(pinInput.value + digit);
      pinInput.focus();
    }

    function clearPin() {
      pinInput.value = '';
      pinInput.focus();
    }

    function backspacePin() {
      pinInput.value = pinInput.value.slice(0, -1);
      pinInput.focus();
    }

    pinInput.addEventListener('input', (event) => {
      const sanitized = sanitizePin(event.target.value);
      if (sanitized !== event.target.value) {
        event.target.value = sanitized;
      }
    });

    pinInput.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        login();
      }
    });

    pinInput.focus();

    // Fonction de connexion : envoie le PIN au serveur et gère la réponse
    function login() {
      const pin = sanitizePin(pinInput.value);
      pinInput.value = pin;
      fetch('/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({pin:pin})
      }).then(r => r.json()).then(data => {
        if (data.success) {
          document.getElementById('loginForm').style.display='none';
          document.getElementById('dashboard').style.display='block';
          loadIO();
          loadDMM();
          setInterval(loadDMM, 1000);
        } else {
          document.getElementById('loginStatus').innerText = data.error || 'Échec';
        }
      }).catch(() => {
        document.getElementById('loginStatus').innerText = 'Erreur de connexion';
      });
    }
    // Charge la liste des IO et met à jour les sélecteurs et la liste
    function loadIO() {
      fetch('/api/io').then(r => r.json()).then(data => {
        const dmmSel = document.getElementById('dmmSelect');
        const funcSel = document.getElementById('funcTarget');
        dmmSel.innerHTML='';
        funcSel.innerHTML='';
        const list = document.getElementById('ioList');
        list.innerHTML='';
        data.forEach(io => {
          const opt1=document.createElement('option');
          opt1.value=io.id;
          opt1.innerText=io.id;
          dmmSel.appendChild(opt1);
          const opt2=document.createElement('option');
          opt2.value=io.id;
          opt2.innerText=io.id;
          funcSel.appendChild(opt2);
          const li=document.createElement('li');
          li.textContent = io.id + ' : ' + io.raw.toFixed(3);
          list.appendChild(li);
        });
      });
    }
    // Charge les valeurs du multimètre et met à jour l'affichage
    function loadDMM() {
      fetch('/api/dmm').then(r => r.json()).then(data => {
        const div=document.getElementById('dmmValues');
        div.innerHTML='';
        for (const ch in data) {
          const p=document.createElement('p');
          p.textContent = ch + ' : ' + data[ch] + ' V';
          div.appendChild(p);
        }
      });
    }
    // Envoie la configuration du générateur au serveur
    function updateFunc() {
      const target=document.getElementById('funcTarget').value;
      const freq=parseFloat(document.getElementById('funcFreq').value);
      const amp=parseFloat(document.getElementById('funcAmp').value);
      const off=parseFloat(document.getElementById('funcOff').value);
      const wave=document.getElementById('funcWave').value;
      fetch('/api/funcgen', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({target:target,freq:freq,amplitude:amp,offset:off,wave:wave})
      }).then(r => r.json()).then(data => {
        if(!data.success) alert('Erreur lors de la mise à jour du générateur');
      });
    }
    // Gestion des logs en WebSocket
    let ws=null;
    let logsVisible=false;
    function toggleLogs() {
      const panel=document.getElementById('logsPanel');
      const btn=document.getElementById('logsBtn');
      if(!logsVisible) {
        panel.style.display='block';
        btn.textContent='Masquer les logs';
        logsVisible=true;
        ws=new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/ws/logs');
        ws.onmessage=function(ev) {
          const line=document.createElement('div');
          line.textContent=ev.data;
          panel.appendChild(line);
          panel.scrollTop=panel.scrollHeight;
        };
        ws.onclose=function(){ logsVisible=false; btn.textContent='Afficher les logs'; panel.style.display='none'; };
      } else {
        if(ws) ws.close();
        ws=null;
        logsVisible=false;
        btn.textContent='Afficher les logs';
        panel.style.display='none';
      }
    }
  </script>
</body>
</html>