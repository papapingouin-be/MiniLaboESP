<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MiniLabo Dashboard</title>
  <style>
    body { background:#f4f6fb; color:#1f2933; font-family:Arial,Helvetica,sans-serif; margin:0; }
    header { padding:1.25rem; text-align:center; font-size:1.6rem; background:#ffffff; color:#1f2933; border-bottom:1px solid #d0d7de; box-shadow:0 2px 6px rgba(15,23,42,0.08); }
    #loginForm { width:320px; margin:4rem auto; padding:2.25rem; background:#ffffff; color:#1f2933; border-radius:0.85rem; box-shadow:0 18px 40px rgba(15,23,42,0.18); }
    #loginForm input { width:100%; padding:0.65rem; margin:0.5rem 0; background:#f9fafc; border:1px solid #cbd5e1; border-radius:0.55rem; color:#1f2933; box-shadow:inset 0 1px 2px rgba(15,23,42,0.05); }
    #loginForm .numpad { display:grid; grid-template-columns:repeat(3,1fr); gap:0.6rem; margin-top:1.2rem; }
    #loginForm .numpad button { background:#e2e8f0; color:#1f2933; padding:0.85rem; font-size:1.25rem; border:none; border-radius:0.6rem; transition:background 0.2s ease, transform 0.1s ease; }
    #loginForm .numpad button:hover { background:#cbd5f5; transform:translateY(-1px); }
    #loginForm .numpad-actions { display:flex; gap:0.6rem; margin-top:0.6rem; }
    #loginForm .numpad-actions button { flex:1; background:#dbeafe; color:#1f2937; border:none; border-radius:0.6rem; }
    #dashboard { display:none; padding:1.5rem; }
    .cards { display:flex; flex-wrap:wrap; gap:1.25rem; }
    .card { background:#ffffff; border:1px solid #e2e8f0; border-radius:0.85rem; padding:1.25rem; flex:1; min-width:250px; box-shadow:0 12px 30px rgba(15,23,42,0.12); }
    button { background:#2563eb; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:0.5rem; cursor:pointer; transition:background 0.2s ease, transform 0.1s ease; }
    button:hover { background:#1d4ed8; transform:translateY(-1px); }
    input, select { background:#f9fafc; border:1px solid #cbd5e1; color:#1f2933; border-radius:0.5rem; padding:0.4rem 0.5rem; box-shadow:inset 0 1px 2px rgba(15,23,42,0.05); }
    #logsPanel { background:#f9fafc; border:1px solid #d0d7de; max-height:220px; overflow:auto; padding:0.75rem; margin-top:1rem; border-radius:0.6rem; box-shadow:inset 0 1px 3px rgba(15,23,42,0.1); }
    #debugToggle { display:inline-block; margin-top:0.75rem; color:#2563eb; text-decoration:none; font-size:0.95rem; }
    #debugToggle:hover { text-decoration:underline; }
    #debugPanel { display:none; margin-top:0.75rem; background:#f9fafc; border:1px solid #d0d7de; border-radius:0.6rem; padding:0.75rem; box-shadow:inset 0 1px 3px rgba(15,23,42,0.1); }
    #debugPanel h3 { margin-top:0; font-size:1rem; color:#1f2933; }
    #debugLog { max-height:160px; overflow:auto; background:#ffffff; border:1px solid #cbd5e1; border-radius:0.5rem; padding:0.5rem; font-size:0.85rem; line-height:1.3; }
  </style>
</head>
<body>
  <header>MiniLabo</header>
  <div id="loginForm">
    <h2>Connexion</h2>
    <label for="pinInput">Code PIN&nbsp;:</label><br>
    <input type="password" id="pinInput" maxlength="4" inputmode="numeric" pattern="[0-9]*"><br>
    <div class="numpad">
      <button type="button" onclick="appendDigit('1')">1</button>
      <button type="button" onclick="appendDigit('2')">2</button>
      <button type="button" onclick="appendDigit('3')">3</button>
      <button type="button" onclick="appendDigit('4')">4</button>
      <button type="button" onclick="appendDigit('5')">5</button>
      <button type="button" onclick="appendDigit('6')">6</button>
      <button type="button" onclick="appendDigit('7')">7</button>
      <button type="button" onclick="appendDigit('8')">8</button>
      <button type="button" onclick="appendDigit('9')">9</button>
      <div></div>
      <button type="button" onclick="appendDigit('0')">0</button>
      <div></div>
    </div>
    <div class="numpad-actions">
      <button type="button" onclick="clearPin()">Effacer</button>
      <button type="button" onclick="backspacePin()">⌫</button>
    </div>
    <button type="button" onclick="login()">Se connecter</button>
    <button type="button" onclick="triggerOledTest()" style="margin-top:0.6rem;">Test OLED</button>
    <p id="loginStatus" style="color:red;"></p>
    <a href="#" id="debugToggle" onclick="toggleDebug(event)">Afficher le debug</a>
    <div id="debugPanel">
      <h3>Debug</h3>
      <pre id="debugLog"></pre>
    </div>
  </div>
  <div id="dashboard">
    <div class="cards">
      <div class="card" id="cardDMM">
        <h3>Multimètre</h3>
        <div id="dmmValues">...</div>
        <div>
          Canal: <select id="dmmSelect"></select>
        </div>
      </div>
      <div class="card" id="cardScope">
        <h3>Oscilloscope</h3>
        <canvas id="scopeCanvas" width="300" height="150" style="background:#f1f5f9;border:1px solid #cbd5e1;border-radius:0.5rem;"></canvas>
        <p>En développement...</p>
      </div>
      <div class="card" id="cardFunc">
        <h3>Générateur de fonction</h3>
        <div>
          Cible: <select id="funcTarget"></select><br>
          Fréquence (Hz): <input type="number" id="funcFreq" value="50"><br>
          Amplitude (%): <input type="number" id="funcAmp" value="50"><br>
          Offset (%): <input type="number" id="funcOff" value="0"><br>
          Forme: <select id="funcWave">
            <option value="sine">Sinus</option>
            <option value="square">Carré</option>
            <option value="triangle">Triangle</option>
          </select><br>
          <button onclick="updateFunc()">Appliquer</button>
        </div>
      </div>
      <div class="card" id="cardIO">
        <h3>IO disponibles</h3>
        <ul id="ioList" style="list-style:none; padding-left:0;"></ul>
      </div>
    </div>
    <div>
      <button onclick="toggleLogs()" id="logsBtn">Afficher les logs</button>
    </div>
    <div id="logsPanel" style="display:none;"></div>
  </div>
  <script>
    const pinInput = document.getElementById('pinInput');
    const debugPanel = document.getElementById('debugPanel');
    const debugLog = document.getElementById('debugLog');
    const debugToggleLink = document.getElementById('debugToggle');
    let lastSentPin = '';
    let uiSocket = null;
    const pendingUiEvents = [];
    const UI_SOCKET_RETRY_MS = 3000;

    function flushPendingUiEvents() {
      if (!uiSocket || uiSocket.readyState !== WebSocket.OPEN) {
        return;
      }
      while (pendingUiEvents.length) {
        const payload = pendingUiEvents.shift();
        try {
          uiSocket.send(payload);
          try {
            const parsed = JSON.parse(payload);
            appendDebug(`event ws (retry) => ${parsed.type || '?'}`);
          } catch (_) {
            appendDebug('event ws (retry)');
          }
        } catch (err) {
          console.warn('ui socket retry error', err);
          appendDebug(`event ws retry erreur: ${err}`);
          pendingUiEvents.unshift(payload);
          break;
        }
      }
    }

    function ensureUiSocket() {
      if (uiSocket && (uiSocket.readyState === WebSocket.OPEN || uiSocket.readyState === WebSocket.CONNECTING)) {
        return;
      }
      connectUiSocket();
    }

    function connectUiSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
      try {
        uiSocket = new WebSocket(protocol + window.location.host + '/ws/ui');
      } catch (err) {
        console.warn('ui socket init error', err);
        appendDebug(`ui socket init erreur: ${err}`);
        uiSocket = null;
        return;
      }
      uiSocket.addEventListener('open', () => {
        appendDebug('UI socket connecté');
        flushPendingUiEvents();
      });
      uiSocket.addEventListener('message', (event) => {
        if (event && event.data) {
          appendDebug(`ui <= ${event.data}`);
        }
      });
      uiSocket.addEventListener('close', () => {
        appendDebug('UI socket fermé');
        uiSocket = null;
        setTimeout(ensureUiSocket, UI_SOCKET_RETRY_MS);
      });
      uiSocket.addEventListener('error', (event) => {
        console.warn('ui socket error', event);
        appendDebug('ui socket erreur');
      });
    }

    function toggleDebug(event) {
      if (event) {
        event.preventDefault();
      }
      if (!debugPanel || !debugToggleLink) {
        return false;
      }
      const isHidden = debugPanel.style.display === 'none' || debugPanel.style.display === '';
      debugPanel.style.display = isHidden ? 'block' : 'none';
      debugToggleLink.textContent = isHidden ? 'Masquer le debug' : 'Afficher le debug';
      if (!isHidden && debugLog) {
        debugLog.scrollTop = debugLog.scrollHeight;
      }
      return false;
    }

    function appendDebug(message) {
      if (!debugLog) {
        return;
      }
      const timestamp = new Date().toISOString();
      debugLog.textContent += `[${timestamp}] ${message}\n`;
      if (debugLog.textContent.length > 8000) {
        debugLog.textContent = debugLog.textContent.slice(debugLog.textContent.length - 8000);
      }
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    ensureUiSocket();

    async function sendLoginEvent(type, details) {
      const payloadObj = Object.assign({type:type}, details || {});
      const payloadJson = JSON.stringify(payloadObj);
      const debugDetails = JSON.stringify(details || {});
      if (uiSocket && uiSocket.readyState === WebSocket.OPEN) {
        try {
          uiSocket.send(payloadJson);
          appendDebug(`event ws => ${type} ${debugDetails}`);
          return;
        } catch (err) {
          console.warn('ui socket send error', err);
          appendDebug(`event ws erreur => ${err}`);
        }
      }

      ensureUiSocket();

      try {
        const response = await fetch('/api/login/event', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'same-origin',
          keepalive:true,
          cache:'no-store',
          body: payloadJson
        });
        appendDebug(`event http => ${type} ${debugDetails} status=${response.status}`);
        if (!response.ok) {
          throw new Error('HTTP '+response.status);
        }
      } catch (e) {
        console.warn('login event http error', e);
        appendDebug(`event http erreur => ${e}`);
        pendingUiEvents.push(payloadJson);
        if (pendingUiEvents.length > 20) {
          pendingUiEvents.shift();
        }
        flushPendingUiEvents();
      }
    }

    function notifyPinChange() {
      const pin = sanitizePin(pinInput.value);
      if (pin !== lastSentPin) {
        lastSentPin = pin;
        sendLoginEvent('pin_update', {pin: pin});
        appendDebug(`pin_update local => ${pin}`);
      }
    }

    function sanitizePin(value) {
      return (value || '').replace(/[^0-9]/g, '').slice(0, 4);
    }

    function appendDigit(digit) {
      pinInput.value = sanitizePin(pinInput.value + digit);
      pinInput.focus();
      notifyPinChange();
    }

    function clearPin() {
      pinInput.value = '';
      pinInput.focus();
      notifyPinChange();
    }

    function backspacePin() {
      pinInput.value = pinInput.value.slice(0, -1);
      pinInput.focus();
      notifyPinChange();
    }

    pinInput.addEventListener('input', (event) => {
      const sanitized = sanitizePin(event.target.value);
      if (sanitized !== event.target.value) {
        event.target.value = sanitized;
      }
      notifyPinChange();
    });

    pinInput.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        login();
      }
    });

    pinInput.focus();
    sendLoginEvent('page_load');
    notifyPinChange();

    function triggerOledTest() {
      sendLoginEvent('test_message', {message:'test'});
      if (typeof appendDebug === 'function') {
        appendDebug('test_message envoyé');
      }
    }

    function login() {
      const pin = sanitizePin(pinInput.value);
      pinInput.value = pin;
      fetch('/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({pin:pin})
      }).then(r => r.json()).then(data => {
        appendDebug(`login response => ${JSON.stringify(data)}`);
        if (data.success) {
          document.getElementById('loginForm').style.display='none';
          document.getElementById('dashboard').style.display='block';
          loadIO();
          loadFuncTargets();
          loadDmmChannels();
          startLogs();
          sendLoginEvent('login_result', {success:true, message:'Connexion OK', pin:pin});
        } else {
          document.getElementById('loginStatus').innerText='PIN incorrect';
          sendLoginEvent('login_result', {success:false, message:'PIN incorrect', pin:pin});
        }
      }).catch(err => {
        document.getElementById('loginStatus').innerText='Erreur: '+err;
        appendDebug(`login error => ${err}`);
        sendLoginEvent('login_result', {success:false, message:'Erreur: '+err, pin:pin});
      });
    }

    function checkAuthResponse(resp) {
      if (resp.status === 401) {
        document.getElementById('loginForm').style.display='block';
        document.getElementById('dashboard').style.display='none';
        document.getElementById('loginStatus').innerText='Veuillez vous reconnecter';
        throw new Error('Unauthorized');
      }
      return resp;
    }

    function loadIO() {
      fetch('/api/io', {credentials:'same-origin'})
        .then(checkAuthResponse)
        .then(r => r.json()).then(data => {
        const list = document.getElementById('ioList');
        list.innerHTML='';
        (data || []).forEach(io => {
          const li = document.createElement('li');
          li.textContent = io.id+': '+io.raw;
          list.appendChild(li);
        });
      });
    }

    function loadDmmChannels() {
      fetch('/api/dmm', {credentials:'same-origin'})
        .then(checkAuthResponse)
        .then(r => r.json()).then(data => {
        const select = document.getElementById('dmmSelect');
        select.innerHTML='';
        if (data.channels) {
          data.channels.forEach((ch, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = ch.name;
            select.appendChild(opt);
          });
        }
        if (data.display) {
          document.getElementById('dmmValues').textContent = data.display;
        }
      });
    }

    function loadFuncTargets() {
      fetch('/api/config/funcgen', {credentials:'same-origin'})
        .then(checkAuthResponse)
        .then(r => r.json()).then(cfg => {
        const select = document.getElementById('funcTarget');
        select.innerHTML='';
        if (cfg.targets) {
          cfg.targets.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id;
            opt.textContent = t.name || t.id;
            select.appendChild(opt);
          });
        }
      });
    }

    function updateFunc() {
      const payload = {
        target: document.getElementById('funcTarget').value,
        freq: parseFloat(document.getElementById('funcFreq').value),
        amplitude: parseFloat(document.getElementById('funcAmp').value),
        offset: parseFloat(document.getElementById('funcOff').value),
        wave: document.getElementById('funcWave').value
      };
      fetch('/api/funcgen', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify(payload)
      }).then(checkAuthResponse).then(r => r.json()).then(resp => {
        if (!resp.success) {
          alert('Erreur lors de la mise à jour du générateur');
        }
      }).catch(err => alert('Erreur réseau: '+err));
    }

    let logsVisible = false;
    let ws;

    function toggleLogs() {
      logsVisible = !logsVisible;
      document.getElementById('logsPanel').style.display = logsVisible ? 'block' : 'none';
      document.getElementById('logsBtn').innerText = logsVisible ? 'Masquer les logs' : 'Afficher les logs';
      if (logsVisible) {
        startLogs();
      } else if (ws) {
        ws.close();
      }
    }

    function startLogs() {
      if (ws) {
        ws.close();
      }
      ws = new WebSocket('ws://'+window.location.host+'/ws/logs');
      ws.onmessage = (evt) => {
        const panel = document.getElementById('logsPanel');
        panel.textContent += evt.data+'\n';
        panel.scrollTop = panel.scrollHeight;
      };
      ws.onclose = () => { ws = null; };
    }

    setInterval(() => {
      if (document.getElementById('dashboard').style.display === 'block') {
        loadIO();
        loadDmmChannels();
      }
    }, 2000);
  </script>
</body>
</html>